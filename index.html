<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teddy Voice Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: #eee;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      text-align: center;
      padding: clamp(1.5rem, 3vw, 2rem);
      padding-bottom: 0;
    }
    header h1 {
      font-size: clamp(1.8rem, 6vw, 2.5rem);
      margin-bottom: 0.3em;
    }
    header p {
      color: #7aa2f7;
      font-size: clamp(0.85rem, 2vw, 1rem);
    }
    .footer {
      text-align: center;
      padding: clamp(0.8rem, 2vw, 1.2rem);
      color: #ccc;
      font-size: clamp(0.75rem, 2vw, 0.85rem);
    }
    .footer a {
      color: #ccc;
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .footer a:hover { color: #7aa2f7; }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: clamp(0.5rem, 3vw, 1.5rem);
      max-width: 720px;
      width: 100%;
      margin: 0 auto;
    }
    .msg {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.8rem;
      align-items: flex-start;
    }
    .msg.user { flex-direction: row-reverse; }
    .msg .avatar {
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    .msg .bubble {
      max-width: 80%;
      padding: 0.8rem 1rem;
      border-radius: 16px;
      line-height: 1.6;
      font-size: clamp(0.9rem, 2.5vw, 1rem);
    }
    .msg.assistant .bubble {
      background: rgba(255,255,255,0.08);
      border-bottom-left-radius: 4px;
    }
    .msg.user .bubble {
      background: #7aa2f7;
      color: #1a1a2e;
      border-bottom-right-radius: 4px;
    }
    .controls {
      padding: clamp(1rem, 3vw, 1.5rem);
      text-align: center;
      background: rgba(0,0,0,0.3);
    }
    #micBtn {
      width: clamp(60px, 15vw, 80px);
      height: clamp(60px, 15vw, 80px);
      border-radius: 50%;
      border: 3px solid #7aa2f7;
      background: transparent;
      color: #7aa2f7;
      font-size: clamp(1.5rem, 5vw, 2rem);
      cursor: pointer;
      transition: all 0.3s;
    }
    #micBtn:hover { background: rgba(122,162,247,0.15); }
    #micBtn.recording {
      border-color: #f7768e;
      color: #f7768e;
      animation: pulse 1.5s infinite;
    }
    #micBtn.thinking {
      border-color: #e0af68;
      color: #e0af68;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(122,162,247,0.4); }
      50% { box-shadow: 0 0 0 15px rgba(122,162,247,0); }
    }
    #status {
      margin-top: 0.5rem;
      font-size: clamp(0.75rem, 2vw, 0.85rem);
      color: #aaa;
    }
    .input-row {
      display: flex;
      gap: 0.5rem;
      max-width: 720px;
      width: 100%;
      margin: 0 auto;
      padding: 0 clamp(0.5rem, 3vw, 1.5rem);
      margin-bottom: 0.8rem;
    }
    #textInput {
      flex: 1;
      padding: 0.6rem 1rem;
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.08);
      color: #eee;
      font-size: 1rem;
      outline: none;
    }
    #textInput:focus { border-color: #7aa2f7; }
    #sendBtn {
      padding: 0.6rem 1.2rem;
      border-radius: 24px;
      border: none;
      background: #7aa2f7;
      color: #1a1a2e;
      font-size: 1rem;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ§¸ Teddy Voice Chat</h1>
    <p>ãƒ†ãƒ‡ã‚£ã¨ãŠã—ã‚ƒã¹ã‚Šã—ã‚ˆã†</p>
  </header>

  <div id="chat"></div>

  <div class="input-row">
    <input type="text" id="textInput" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã§å…¥åŠ›..." />
    <button id="sendBtn">é€ä¿¡</button>
  </div>

  <div class="controls">
    <button id="micBtn">ğŸ¤</button>
    <button id="voiceToggle" style="margin-left:1rem;padding:0.5rem 1rem;border-radius:20px;border:2px solid #7aa2f7;background:transparent;color:#7aa2f7;cursor:pointer;font-size:0.9rem;">ğŸ”Š èª­ã¿ä¸Šã’ ON</button>
    <div id="status">ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„</div>
  </div>

  <div class="footer">
    <a href="/">â† Home</a>
  </div>

  <script>
    const API_URL = 'https://teddy.bon-soleil.com/api/chat';
    const chat = document.getElementById('chat');
    const micBtn = document.getElementById('micBtn');
    const status = document.getElementById('status');
    const textInput = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');

    let recognition = null;
    let isRecording = false;
    let synth = window.speechSynthesis;
    let voiceEnabled = true;
    let conversationHistory = [];  // ä¼šè©±å±¥æ­´ï¼ˆç›´è¿‘10å¾€å¾©=20ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
    const voiceToggle = document.getElementById('voiceToggle');
    voiceToggle.addEventListener('click', () => {
      voiceEnabled = !voiceEnabled;
      voiceToggle.textContent = voiceEnabled ? 'ğŸ”Š èª­ã¿ä¸Šã’ ON' : 'ğŸ”‡ èª­ã¿ä¸Šã’ OFF';
      voiceToggle.style.borderColor = voiceEnabled ? '#7aa2f7' : '#555';
      voiceToggle.style.color = voiceEnabled ? '#7aa2f7' : '#555';
      if (!voiceEnabled) synth.cancel();
    });

    // Speech Recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        addMessage('user', text);
        sendMessage(text);
      };

      recognition.onend = () => {
        isRecording = false;
        micBtn.classList.remove('recording');
      };

      recognition.onerror = (e) => {
        isRecording = false;
        micBtn.classList.remove('recording');
        status.textContent = `ã‚¨ãƒ©ãƒ¼: ${e.error}`;
      };
    }

    micBtn.addEventListener('click', () => {
      if (!recognition) {
        status.textContent = 'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
        return;
      }
      if (isRecording) {
        recognition.stop();
        return;
      }
      synth.cancel();
      isRecording = true;
      micBtn.classList.add('recording');
      status.textContent = 'è´ã„ã¦ã„ã¾ã™...';
      recognition.start();
    });

    // Text input
    sendBtn.addEventListener('click', () => {
      const text = textInput.value.trim();
      if (!text) return;
      addMessage('user', text);
      sendMessage(text);
      textInput.value = '';
    });

    let isComposing = false;
    textInput.addEventListener('compositionstart', () => { isComposing = true; });
    textInput.addEventListener('compositionend', () => { isComposing = false; });
    textInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !isComposing) {
        e.preventDefault();
        const text = textInput.value.trim();
        if (!text) return;
        addMessage('user', text);
        sendMessage(text);
        textInput.value = '';
      }
    });

    function addMessage(role, text) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ§¸';
      div.innerHTML = `<span class="avatar">${avatar}</span><div class="bubble">${escapeHtml(text)}</div>`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML;
    }

    function linkify(text) {
      const escaped = escapeHtml(text);
      return escaped.replace(
        /(https?:\/\/[^\s<]+)/g,
        '<a href="$1" target="_blank" rel="noopener" style="color:#7aa2f7;text-decoration:underline;">$1</a>'
      );
    }

    async function sendMessage(text) {
      micBtn.classList.add('thinking');
      status.textContent = 'è€ƒãˆã¦ã„ã¾ã™...';

      const msgDiv = addMessage('assistant', '');
      const bubble = msgDiv.querySelector('.bubble');
      let fullText = '';

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, history: conversationHistory }),
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') break;
              try {
                const parsed = JSON.parse(data);
                if (parsed.content) {
                  fullText += parsed.content;
                  bubble.innerHTML = linkify(fullText);
                  chat.scrollTop = chat.scrollHeight;
                }
              } catch {}
            }
          }
        }

        // ä¼šè©±å±¥æ­´ã«è¿½åŠ ï¼ˆç›´è¿‘20ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åˆ¶é™ï¼‰
        conversationHistory.push({ role: 'user', content: text });
        if (fullText) {
          conversationHistory.push({ role: 'assistant', content: fullText });
        }
        if (conversationHistory.length > 20) {
          conversationHistory = conversationHistory.slice(-20);
        }

        // éŸ³å£°ã§èª­ã¿ä¸Šã’
        if (fullText && synth && voiceEnabled) {
          const utter = new SpeechSynthesisUtterance(fullText);
          utter.lang = 'ja-JP';
          utter.rate = 1.1;
          synth.speak(utter);
          status.textContent = 'è©±ã—ã¦ã„ã¾ã™...';
          utter.onend = () => {
            status.textContent = 'ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„';
          };
        }
      } catch (err) {
        bubble.textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
        status.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        console.error(err);
      }

      micBtn.classList.remove('thinking');
      if (!synth.speaking) {
        status.textContent = 'ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„';
      }
    }
  </script>
</body>
</html>
